---
title: "Download Ornitela data in Movebank format"
author: "Peter Desmet"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(here)
```

## Get Ornitela tag and bird information from spreadsheet

```{r}
metadata <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSU838D5jOOcPSyL21iheYdC1hEwYaR88x9qhJNLOZtmaTuK6hv23Vpz-o1b5erXur4Vw2g9Z2mQchh/pub?gid=0&single=true&output=csv")
metadata_colnames <- colnames(metadata)
```

## Set project and some values

Some values cannot be automatically assumed for the Movebank format and have to be defined by the user. See [here](https://www.movebank.org/node/2381#metadata) for information on all reference data terms.

Set values:

```{r}
project_id <- "DELTATRACK"
attachment_type <- "harness"
manipulation_type <- "none"
```

## Get reference data (metadata)

For a project, get data on animals, tags and deployments in the [Movebank reference data format](https://www.movebank.org/node/27).

Map data:

```{r get_ref_data}
movebank_ref_data <-
  metadata %>%
  filter(project == project_id) %>%
  mutate(
# animal-comments TODO
# animal-death-comments
# animal-earliest-date-born
# animal-exact-date-of-birth
"animal-id" = metal_ring,
# animal-latest-date-born
"animal-nickname" = if_else(
  !str_detect(name, "OT-"), # Exclude names that are the default tag name
  name,
  NA_character_
),
"animal-ring-id" = colour_ring,
"animal-sex" = recode(sex,
  "F" = "f",
  "M" = "m"
),
"animal-taxon" = scientific_name,
# animal-taxon-detail
"animal-life-stage" = recode(age,
  "A" = "adult"
),
"animal-mass" = weight,
# animal-reproductive-condition
"attachment-type" = attachment_type,
# behavior-according-to
# data-processing-software
# deploy-off-latitude
# deploy-off-longitude
# deploy-off-person
# deploy-off-timestamp TODO
# deploy-on-latitude TODO
# deploy-on-longitud TODO
# deploy-on-person
"deploy-on-timestamp" = as.POSIXct(paste(release_date, time_released), format="%Y-%m-%d %H:%M:%S"), # TODO: is this UTC?
# deployment-comments TODO
# deployment-end-comments
# deployment-end-type TODO
# deployment-id TODO
# duty-cycle
# geolocator-calibration
# geolocator-light-threshold
# geolocator-sensor-comments
# geolocator-sun-elevation-angle
# habitat-according-to
# location-accuracy-comments TODO
# manipulation-comments
"manipulation-type" = manipulation_type,
"study-site" = location,
"tag-readout-method" = "phone network",
# beacon-frequency
"sensor-type" = "GPS",
# tag-comments
# tag-failure-comments
"tag-id" = serial_number,
"tag-manufacturer-name" = "Ornitela",
# tag-mass TODO
# tag-processing-type
# tag-production-date
"tag-serial-no" = serial_number,
)
```

Remove original columns and sort by tag_id:

```{r}
movebank_ref_data <-
  movebank_ref_data %>%
  select(!one_of(metadata_colnames)) %>%
  arrange(tag_id)
```

Save to CSV:

```{r}
write_csv(movebank_ref_data, path = here("data", "processed", project_id, "movebank_ref_data.csv"), na = "")
```

## Get gps data (detections)

Done via live feed.

## Get acceleration data

Done via live feed.
