---
title: "Download Ornitela data in Movebank format"
author: "Peter Desmet"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(here)
```

## Get Ornitela tag and bird information from spreadsheet

```{r}
metadata <- read_csv("https://docs.google.com/spreadsheets/d/e/2PACX-1vSU838D5jOOcPSyL21iheYdC1hEwYaR88x9qhJNLOZtmaTuK6hv23Vpz-o1b5erXur4Vw2g9Z2mQchh/pub?gid=0&single=true&output=csv")
metadata_colnames <- colnames(metadata)
```

## Set project and some values

Some values cannot be automatically assumed for the Movebank format and have to be defined by the user. See [here](https://www.movebank.org/node/2381#metadata) for information on all reference data terms.

Set values:

```{r}
project_id <- "DELTATRACK"
attachment_type <- "harness"
manipulation_type <- "none"
```

## Get reference data (metadata)

For a project, get data on animals, tags and deployments in the [Movebank reference data format](https://www.movebank.org/node/27).

Map data. Fields indicated with `NOT AVAILABLE` are not available in Ornitela metadata, but included to have the same columns as in [UvA-BiTS reference data](../sql/movebank_ref.sql):

```{r get_ref_data}
# 

movebank_ref_data <-
  metadata %>%
  filter(project == project_id) %>%
  mutate(
    `animal-comments` = NA_character_, # NOT USED
    # animal-death-comments
    # animal-earliest-date-born
    # animal-exact-date-of-birth
    `animal-id` = metal_ring,
    # animal-latest-date-born
    `animal-nickname` = if_else(
      !str_detect(bird_name, "OT-"), # Exclude names that are the default tag name
      bird_name,
      NA_character_
    ),
    `animal-ring-id` = colour_ring,
    `animal-sex` = recode(sex,
      "F" = "f",
      "M" = "m"
    ),
    `animal-taxon` = scientific_name,
    # animal-taxon-detail
    `animal-life-stage` = recode(age,
      "A" = "adult",
      "J" = "juvenile"
    ),
    `animal-mass` = bird_weight,
    # animal-reproductive-condition
    `attachment-type` = attachment_type,
    # behavior-according-to
    # data-processing-software
    # deploy-off-latitude
    # deploy-off-longitude
    # deploy-off-person
    `deploy-off-timestamp` = as.POSIXct(track_session_end_date),
    `deploy-on-latitude` = NA_real_, # NOT USED
    `deploy-on-longitude` = NA_real_, # NOT USED
    # deploy-on-person
    `deploy-on-timestamp` = as.POSIXct(paste(release_date, "18:00:00"), format="%Y-%m-%d %H:%M:%S"),
    `deployment-comments` = paste0(
      release_location,
      if_else(!is.na(track_session_remarks), paste0(" | ", track_session_remarks), "")
    ),
    # deployment-end-comments
    `deployment-end-type` = if_else(
      !str_detect(track_session_remarks, "dead"),
      "dead",
      NA_character_
    ),
    `deployment-id` = NA_integer_, # NOT USED
    # duty-cycle
    # geolocator-calibration
    # geolocator-light-threshold
    # geolocator-sensor-comments
    # geolocator-sun-elevation-angle
    # habitat-according-to
    `location-accuracy-comments` = NA_character_, # NOT USED, there is no location-error-numerical/vertical-error-numerical in the gps data
    # manipulation-comments
    `manipulation-type` = manipulation_type,
    `study-site` = project_id,
    `tag-readout-method` = "phone network",
    # beacon-frequency
    `sensor-type` = "GPS",
    # tag-comments
    # tag-failure-comments
    `tag-id` = serial_number,
    `tag-manufacturer-name` = "Ornitela",
    `tag-mass` = tag_weight,
    # tag-processing-type
    # tag-production-date
    `tag-serial-no` = serial_number,
)
```

Remove original columns and sort by tag_id:

```{r}
movebank_ref_data <-
  movebank_ref_data %>%
  select(!one_of(metadata_colnames)) %>%
  arrange("tag-id")
```

Save to CSV:

```{r}
write_csv(movebank_ref_data, path = here("data", "processed", project_id, "movebank_ref_data.csv"), na = "")
```

## Get gps data (detections)

Done via live feed.

## Get acceleration data

Not implemented yet.
