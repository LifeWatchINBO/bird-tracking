---
title: "Download UvA-BiTS tracking data for an individual"
author: "Peter Desmet"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(DBI)
library(here)
library(glue)
```

## Connect to UvA-BiTS database

Get connection settings from `config.yml` (not included in this repo) and connect to database:

```{r connect_to_uvabits}
uvabits <- config::get("uvabits")
con = dbConnect(
  RPostgres::Postgres(),
  host = uvabits$server,
  port = uvabits$port,
  user = uvabits$username,
  password = uvabits$password,
  dbname = uvabits$database
)

# The alternative is getting the connection defined in odbc.ini:
# con <- dbConnect(odbc::odbc(), "uvabits")
```

# Set values

Project:

```{r}
project <- "MH_WATERLAND"
```

Get `device_info_serial`s for that project(s). Note that because of the reuse of tags, there might be less `device_info_serials` than bird individuals:

```{r}
device_info_serials <- read_csv(here("data", "interim", "individuals.csv")) %>%
  filter(key_name == project) %>%
  distinct(device_info_serial, .keep_all = TRUE) %>%
  arrange(device_info_serial) %>%
  pull(device_info_serial)

# device_info_serials <- 586 # To test with a single value
```

Load custom function to iterate over device_info_serials:

```{r}
source(here("src", "functions", "download_gps.R"))
```

## Get GPS data in raw format:

Set download directory and SQL template:

```{r}
download_directory = here("data", "interim", project)
sql <- here("sql", "gps.sql")
```

Query data:

```{r}
download_gps(sql, download_directory, device_info_serials, con, FALSE)
```

## Get GPS data in Movebank format

Set download directory and SQL template:

```{r}
download_directory = here("data", "movebank", project)
movebank_sql <- here("sql", "gps_movebank.sql")
```

Query data:

```{r query_detections}
download_detections(movebank_sql, download_directory, device_info_serials, con, FALSE)
```
