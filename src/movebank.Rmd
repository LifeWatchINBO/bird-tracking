---
title: "Download UvA-BiTS data in Movebank format"
author: "Peter Desmet"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(DBI)
library(here)
library(glue)
```

## Connect to UvA-BiTS database

Get connection settings from `config.yml` (not included in this repo) and connect to database:

```{r connect_to_uvabits}
uvabits <- config::get("uvabits")
con = dbConnect(
  RPostgres::Postgres(),
  host = uvabits$server,
  port = uvabits$port,
  user = uvabits$username,
  password = uvabits$password,
  dbname = uvabits$database
)

# The alternative is getting the connection defined in odbc.ini:
# con <- dbConnect(odbc::odbc(), "uvabits")
```

## Set project and some values

Some values cannot be automatically assumed for the Movebank format and have to be defined by the user. See [here](https://www.movebank.org/node/2381#metadata) for information on all reference data terms.

Set values:

```{r}
project <- "MH_WATERLAND"
shared <- FALSE
download_directory <- here("data", "movebank", project)
animal_life_stage <- "adult"
attachment_type <- "harness"
manipulation_type <- "none"
bird_remarks_is_nickname <- TRUE
overwrite_files <- TRUE
```

## Get reference data (metadata)

For a project, get data on animals, tags and deployments in the [Movebank reference data format](https://www.movebank.org/node/27).

Query data:

```{r get_ref_data}
movebank_ref_sql <- glue_sql(read_file(here("sql", "movebank_ref.sql")), .con = con)
movebank_ref_data <- dbGetQuery(con, movebank_ref_sql)
```

Save to CSV:

```{r}
write_csv(movebank_ref_data, path = here("data", "processed", project, "movebank_ref_data.csv"), na = "")
```

## Get ringnumbers

Get all ring numbers for the project. Note that this is a better identifier than `device_info_serial` as it is unique to an individual (and cannot be reused).

```{r}
ring_numbers <- read_csv(here("data", "interim", "individuals.csv")) %>%
  filter(key_name == project) %>%
  distinct(ring_number, .keep_all = TRUE) %>%
  arrange(ring_number) %>%
  pull(ring_number)
```

Load custom function to download data (will iterate over ring numbers):

```{r}
source(here("src", "functions", "download_data.R"))
```

## Get gps data (detections)

Query and save data (one csv file per ringnumber):

```{r}
download_data(
  sql_file = here("sql", "movebank_gps.sql"),
  download_directory = here("data", "processed", project),
  download_filename = "movebank_gps",
  ring_numbers = ring_numbers,
  shared = shared,
  con = con,
  overwrite = overwrite_files
)
```

## Get acceleration data

Query and save data (one csv file per ringnumber):

```{r}
download_data(
  sql_file = here("sql", "movebank_acc.sql"),
  download_directory = here("data", "processed", project),
  download_filename = "movebank_acc",
  ring_numbers = ring_numbers,
  shared = shared,
  con = con,
  overwrite = TRUE
)
```

Note that files are uploaded to Movebank separately, but these could be concatenated using:

```
awk 'FNR > 1' movebank_gps_*.csv > movebank_gps.csv
```

After which the header needs to be added manually.

