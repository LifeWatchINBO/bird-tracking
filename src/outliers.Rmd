---
title: "Mark outliers in data in Movebank format"
author:
- Tanja Milotic
- Peter Desmet
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    number_sections: true
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries:

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(sp)
library(trip)
```

```{r}
MH_Waterland_GPS <- read_csv(here::here("data", "processed", "MH_WATERLAND", "gps", "movebank_gps_H173481.csv"))
```

```{r}
```

```{r}
# Calculate speed
MH_W1_step1 <- calc_speed(MH_Waterland_GPS)
```

```{r}
# create a dataframe for the outliers
MH_W1_outliers1 <- MH_W1_step1 %>%
  filter(speed > 30) %>%
  select(timestamp) %>%
  mutate(removal_round = "step1")
# filter the outliers from the dataset, sort by timestamp and calculate speed with the remaining observations
MH_W1_step2 <- MH_W1_step1 %>%
  filter(speed <= 30 | is.na(speed)) %>%
  arrange(timestamp)
MH_W1_step2 <- calc_speed(MH_W1_step2)
MH_W1_outliers2 <- MH_W1_step2 %>%
  filter(speed > 30) %>%
  select(timestamp) %>%
  mutate(removal_round = "step2")
# round 3 of outlier detection
MH_W1_step3 <- MH_W1_step2 %>%
  filter(speed <= 30 | is.na(speed)) %>%
  arrange(timestamp)
MH_W1_step3 <- calc_speed(MH_W1_step3)
MH_W1_outliers3 <- MH_W1_step3 %>%
  filter(speed > 30) %>%
  select(timestamp) %>%
  mutate(removal_round = "step3")
```

```{r}
# create a dataframe with all observations marked as outliers and the step in which it was marked
MH_W1_outliers <- rbind(MH_W1_outliers1, MH_W1_outliers2, MH_W1_outliers3) 

# join the outlier dataframe with the full observations dataframe and mark outliers as 'TRUE' in the 'algorithm.marked.outlier' field
MH_W1 <- left_join(MH_W1_step1, MH_W1_outliers, by = "timestamp") %>%
  mutate(algorithm.marked.outlier = if_else(is.na(removal_round), FALSE, TRUE))
```
